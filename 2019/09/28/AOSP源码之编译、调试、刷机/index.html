<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>AOSP源码之编译、调试、刷机 | 鹏哥的Blog</title><meta name="author" content="peng"><meta name="copyright" content="peng"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="一.准备工作 系统最好是Linux或者mac OS(本文基于Ubuntu)。 Ubuntu设置永不休眠，在setting中搜索power.blank-screen选择never。 一块大一点儿的硬盘，至少得有200G剩余空间。  二.下载Aosp源码1.安装GIT首先需要安装Git，因为源码是用Git管理的。1sudo apt-get install git 接下来创建一个bin文件夹，并加入到P">
<meta property="og:type" content="article">
<meta property="og:title" content="AOSP源码之编译、调试、刷机">
<meta property="og:url" content="https://lxlfpeng.github.io/2019/09/28/AOSP%E6%BA%90%E7%A0%81%E4%B9%8B%E7%BC%96%E8%AF%91%E3%80%81%E8%B0%83%E8%AF%95%E3%80%81%E5%88%B7%E6%9C%BA/index.html">
<meta property="og:site_name" content="鹏哥的Blog">
<meta property="og:description" content="一.准备工作 系统最好是Linux或者mac OS(本文基于Ubuntu)。 Ubuntu设置永不休眠，在setting中搜索power.blank-screen选择never。 一块大一点儿的硬盘，至少得有200G剩余空间。  二.下载Aosp源码1.安装GIT首先需要安装Git，因为源码是用Git管理的。1sudo apt-get install git 接下来创建一个bin文件夹，并加入到P">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://lxlfpeng.github.io/images/about_avatar.webp">
<meta property="article:published_time" content="2019-09-27T16:00:00.000Z">
<meta property="article:modified_time" content="2025-04-12T15:02:01.828Z">
<meta property="article:author" content="peng">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://lxlfpeng.github.io/images/about_avatar.webp"><link rel="shortcut icon" href="/images/favicon.webp"><link rel="canonical" href="https://lxlfpeng.github.io/2019/09/28/AOSP%E6%BA%90%E7%A0%81%E4%B9%8B%E7%BC%96%E8%AF%91%E3%80%81%E8%B0%83%E8%AF%95%E3%80%81%E5%88%B7%E6%9C%BA/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'AOSP源码之编译、调试、刷机',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  isShuoshuo: false
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/images/about_avatar.webp" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">127</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">59</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">24</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/categories"><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background: linear-gradient(20deg, #0062be, #925696, #cc426e, #fb0347);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="/images/nav_logo.webp" alt="Logo"><span class="site-name">鹏哥的Blog</span></a><a class="nav-page-title" href="/"><span class="site-name">AOSP源码之编译、调试、刷机</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/categories"><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">AOSP源码之编译、调试、刷机</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2019-09-27T16:00:00.000Z" title="发表于 2019-09-28 00:00:00">2019-09-28</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Android%E5%BC%80%E5%8F%91/">Android开发</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">8.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>32分钟</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="一-准备工作"><a href="#一-准备工作" class="headerlink" title="一.准备工作"></a>一.准备工作</h1><ul>
<li>系统最好是Linux或者mac OS(本文基于Ubuntu)。</li>
<li>Ubuntu设置永不休眠，在setting中搜索power.blank-screen选择never。</li>
<li>一块大一点儿的硬盘，至少得有200G剩余空间。</li>
</ul>
<h1 id="二-下载Aosp源码"><a href="#二-下载Aosp源码" class="headerlink" title="二.下载Aosp源码"></a>二.下载Aosp源码</h1><h3 id="1-安装GIT"><a href="#1-安装GIT" class="headerlink" title="1.安装GIT"></a>1.安装GIT</h3><h5 id="首先需要安装Git，因为源码是用Git管理的。"><a href="#首先需要安装Git，因为源码是用Git管理的。" class="headerlink" title="首先需要安装Git，因为源码是用Git管理的。"></a>首先需要安装Git，因为源码是用Git管理的。</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install git</span><br></pre></td></tr></table></figure>
<h5 id="接下来创建一个bin文件夹，并加入到PATH中，有点像Windows的环境变量。"><a href="#接下来创建一个bin文件夹，并加入到PATH中，有点像Windows的环境变量。" class="headerlink" title="接下来创建一个bin文件夹，并加入到PATH中，有点像Windows的环境变量。"></a>接下来创建一个bin文件夹，并加入到PATH中，有点像Windows的环境变量。</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir ~/bin</span><br><span class="line">PATH=~/bin:$PATH</span><br></pre></td></tr></table></figure>
<h5 id="然后初始化Git，邮箱和姓名。"><a href="#然后初始化Git，邮箱和姓名。" class="headerlink" title="然后初始化Git，邮箱和姓名。"></a>然后初始化Git，邮箱和姓名。</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global user.email &quot;xxx@gmail.com&quot;</span><br><span class="line">git config --global user.name &quot;xxx&quot;</span><br></pre></td></tr></table></figure>

<h3 id="2-安装Python环境"><a href="#2-安装Python环境" class="headerlink" title="2.安装Python环境"></a>2.安装Python环境</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install python</span><br></pre></td></tr></table></figure>

<h3 id="3-安装repo及配置"><a href="#3-安装repo及配置" class="headerlink" title="3.安装repo及配置"></a>3.安装repo及配置</h3><p>repo 是一个python 脚本(所以我们上面要配置Python环境)，因为Android源码包含数百个git库，简化帮助管理git Android版本库的工具。</p>
<h5 id="1-安装curl下载的库："><a href="#1-安装curl下载的库：" class="headerlink" title="(1.)安装curl下载的库："></a>(1.)安装curl下载的库：</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install curl</span><br></pre></td></tr></table></figure>
<h5 id="2-下载repo并设置可以运行权限。"><a href="#2-下载repo并设置可以运行权限。" class="headerlink" title="(2.)下载repo并设置可以运行权限。"></a>(2.)下载repo并设置可以运行权限。</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl https://mirrors.tuna.tsinghua.edu.cn/git/git-repo &gt; ~/bin/repo</span><br><span class="line">chmod a+x ~/bin/repo</span><br></pre></td></tr></table></figure>
<h5 id="3-添加下载源。"><a href="#3-添加下载源。" class="headerlink" title="(3.)添加下载源。"></a>(3.)添加下载源。</h5><p>google 的AOSP 的话，因为FQ和数据量太大，且需要需要翻墙影响速度，因此优先考虑国内的镜像(本文使用的是清华的源)。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export REPO_URL=&#x27;https://mirrors.tuna.tsinghua.edu.cn/git/git-repo/&#x27;</span><br></pre></td></tr></table></figure>

<h3 id="4-初始化及同步源码"><a href="#4-初始化及同步源码" class="headerlink" title="4.初始化及同步源码"></a>4.初始化及同步源码</h3><h5 id="1-创建文件夹"><a href="#1-创建文件夹" class="headerlink" title="(1.)创建文件夹"></a>(1.)创建文件夹</h5><p>创建一个AOSP文件夹，cdd到文件夹里面去待会儿需要把源码下载到这里:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir aosp</span><br><span class="line">cd aosp</span><br></pre></td></tr></table></figure>
<h5 id="2-初始化Aosp仓库"><a href="#2-初始化Aosp仓库" class="headerlink" title="(2.)初始化Aosp仓库"></a>(2.)初始化Aosp仓库</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">repo init -u https://aosp.tuna.tsinghua.edu.cn/platform/manifest</span><br></pre></td></tr></table></figure>
<h5 id="3-初始化并指定版本"><a href="#3-初始化并指定版本" class="headerlink" title="(3.)初始化并指定版本"></a>(3.)初始化并指定版本</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">repo init -u https://aosp.tuna.tsinghua.edu.cn/platform/manifest -b android-8.0.0_r36</span><br></pre></td></tr></table></figure>
<p>AOSP对应关系查看地址： <a target="_blank" rel="noopener" href="https://source.android.google.cn/setup/start/build-numbers#source-code-tags-and-builds">对应关系</a></p>
<h5 id="4-开始同步源码"><a href="#4-开始同步源码" class="headerlink" title="(4.)开始同步源码"></a>(4.)开始同步源码</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">repo sync -j4</span><br></pre></td></tr></table></figure>
<p>-j表示并发数.</p>
<p><strong>因为Android的源码越来越大，repo sync失败的概率也越来越高。所以我们可以避开使用repo sync的方式，而采用下载预下载包的方式来实现下载源码。</strong></p>
<h3 id="5-预下载包的方式"><a href="#5-预下载包的方式" class="headerlink" title="5.预下载包的方式"></a>5.预下载包的方式</h3><h5 id="1-下载预下载包"><a href="#1-下载预下载包" class="headerlink" title="1. 下载预下载包"></a>1. 下载预下载包</h5><p>在windows或者Linux上面通过迅雷下载<code>https://mirrors.tuna.tsinghua.edu.cn/aosp-monthly/aosp-latest.tar</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -c https://mirrors.tuna.tsinghua.edu.cn/aosp-monthly/aosp-latest.tar #下载初始化包</span><br></pre></td></tr></table></figure>
<h5 id="2-解压预下载包"><a href="#2-解压预下载包" class="headerlink" title="2. 解压预下载包"></a>2. 解压预下载包</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar xf aosp-latest.tar</span><br></pre></td></tr></table></figure>
<blockquote>
<p>cd AOSP-&gt;解压得到的 AOSP 工程目录，这时 ls 的话什么也看不到，因为只有一个隐藏的 .repo 目录</p>
</blockquote>
<h5 id="3-查看分支"><a href="#3-查看分支" class="headerlink" title="3. 查看分支"></a>3. 查看分支</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd .repo/manifests </span><br><span class="line">git branch -a</span><br></pre></td></tr></table></figure>
<h5 id="4-在aosp目录选择需要同步的版本"><a href="#4-在aosp目录选择需要同步的版本" class="headerlink" title="4. 在aosp目录选择需要同步的版本"></a>4. 在aosp目录选择需要同步的版本</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">repo init -b android-9.0.0_r55</span><br><span class="line">repo sync # 正常同步一遍即可得到完整目录</span><br></pre></td></tr></table></figure>
<p>或者直接在aosp目录设置好你要同步的分支:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">repo init -u https://aosp.tuna.tsinghua.edu.cn/platform/manifest -b android-8.0.0_r36</span><br><span class="line">repo sync  # 正常同步一遍即可得到完整目录</span><br></pre></td></tr></table></figure>
<p>如果仅加载具体模块:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">repo sync platform/prebuilts/clang/host/darwin-x86</span><br></pre></td></tr></table></figure>

<h3 id="6-防止下载源码执行脚本卡死"><a href="#6-防止下载源码执行脚本卡死" class="headerlink" title="6.防止下载源码执行脚本卡死"></a>6.防止下载源码执行脚本卡死</h3><p>通过自定义Shell脚本启动源码下载可以有效防止，同步源码时脚本被卡死的问题。</p>
<h5 id="1-在AOSP文件夹中新建down-sh文件"><a href="#1-在AOSP文件夹中新建down-sh文件" class="headerlink" title="(1.)在AOSP文件夹中新建down.sh文件"></a>(1.)在AOSP文件夹中新建down.sh文件</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">echo “======= start repo sync =======”</span><br><span class="line">cd ~/Desktop/AOSP</span><br><span class="line">repo sync -j4</span><br><span class="line">while [ $? == 1 ]; do</span><br><span class="line">echo “====== sync failed! re-sync again =====”</span><br><span class="line">sleep 3</span><br><span class="line">repo sync -j4</span><br></pre></td></tr></table></figure>
<h5 id="2-执行down-sh文件"><a href="#2-执行down-sh文件" class="headerlink" title="(2.)执行down.sh文件"></a>(2.)执行down.sh文件</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh down.sh</span><br></pre></td></tr></table></figure>

<h1 id="三-AOSP源码目录结构"><a href="#三-AOSP源码目录结构" class="headerlink" title="三.AOSP源码目录结构"></a>三.AOSP源码目录结构</h1><ul>
<li>abi Application Binary Interface 应用程序二进制接口，abi相信同学们在SO库调用上遇到过，如果不支持该平台的话就说不ABI不支持。</li>
<li>art Android Runtime 安卓运行时。这个会提前把字节码编译成二进制机器码保存起来，执行的时候加载速度比较快。Dalvik虚拟机则是在加载以后再去编译的，所以速度上ART会比Dalvik快一点。牺牲空间来赢取时间。</li>
<li>bionic 基础库，Android系统与Linux内核的桥梁。Bionic 音标为 bīˈänik，翻译为”仿生”。</li>
<li>bootable 系统启动引导相关程序</li>
<li>build 用于构建Android系统的工具，也就是用于编译Android系统的</li>
<li>cts Compatibility Test Suite 兼容性测试</li>
<li>dalvik dalvik虚拟机，用于解析执行dex文件的虚拟机</li>
<li>developers 开发者目录</li>
<li>developerment 开发目录，比如说应用，application就在里面了，apps</li>
<li>devices 设备相关的配置信息，什么索尼、HTC、自己的产品，就可以定义在这个目录下了</li>
<li>docs 文档</li>
<li>external 开源模组相关文件</li>
<li>frameworks 系统架构，Android的核心了</li>
<li>hardware hal层代码，硬件抽象层</li>
<li>libcore 核心库</li>
<li>libnativehelper native帮助库，实现JNI的相关文件</li>
<li>ndk native development kit</li>
<li>out 输出目录，编译以后生成的目录，相关的产出就在这里了</li>
<li>packages 应用程序包。一些系统的应用就在这里了，比如说蓝牙，Launcher，相机，拨号之类的。</li>
<li>pdk Plug-in Development Kit (PDK) is designed to help you build your own pattern projects</li>
<li>platform_testing 平台测试</li>
<li>prebuilts x86&#x2F;arm架构下预编译的文件</li>
<li>sdk software development kit</li>
<li>system 底层系统文件</li>
<li>toolchain 工具链</li>
<li>tools 工具文件</li>
<li>Makefile mk文件，用于控制编译</li>
</ul>
<h1 id="四-AOSP源码整编"><a href="#四-AOSP源码整编" class="headerlink" title="四.AOSP源码整编"></a>四.AOSP源码整编</h1><p>编译AOSP源码需要配置好JAVA环境.</p>
<h3 id="1-安装Java编译环境"><a href="#1-安装Java编译环境" class="headerlink" title="1.安装Java编译环境"></a>1.安装Java编译环境</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install openjdk-8-jdk</span><br></pre></td></tr></table></figure>

<h3 id="2-进入AOSP文件夹，进行编译"><a href="#2-进入AOSP文件夹，进行编译" class="headerlink" title="2.进入AOSP文件夹，进行编译"></a>2.进入AOSP文件夹，进行编译</h3><h5 id="1-初始化编译环境"><a href="#1-初始化编译环境" class="headerlink" title="(1.)初始化编译环境"></a>(1.)初始化编译环境</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source build/envsetup.sh</span><br></pre></td></tr></table></figure>
<h5 id="2-删除上一次编译的结果，初次编译可以不需要这一步"><a href="#2-删除上一次编译的结果，初次编译可以不需要这一步" class="headerlink" title="(2.)删除上一次编译的结果，初次编译可以不需要这一步"></a>(2.)删除上一次编译的结果，初次编译可以不需要这一步</h5><p><code>make clobber</code></p>
<h5 id="3-选择与设备对应的编译版本"><a href="#3-选择与设备对应的编译版本" class="headerlink" title="(3.)选择与设备对应的编译版本"></a>(3.)选择与设备对应的编译版本</h5><p><code>lunch XX</code></p>
<p>选择与设备对应的编译版本.如:编译开发工程师的版本<code>lunch aosp_x86-eng</code>，可以方便debug<br><a target="_blank" rel="noopener" href="https://source.android.com/setup/build/running#selecting-device-build">编译版本选择</a></p>
<p>如果<code>lunch</code>命令没有加对应的编译版本则会有以下信息输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">You&#x27;re building on Linux</span><br><span class="line"></span><br><span class="line">Lunch menu... pick a combo:</span><br><span class="line"> 1. aosp_arm-eng</span><br><span class="line"> 2. aosp_arm64-eng</span><br><span class="line"> 3. aosp_mips-eng</span><br><span class="line"> 4. aosp_mips64-eng</span><br><span class="line"> 5. aosp_x86-eng</span><br><span class="line"> 6. aosp_x86_64-eng</span><br><span class="line"> 7. full_fugu-userdebug</span><br><span class="line"> 8. aosp_fugu-userdebug</span><br><span class="line"> 9. mini_emulator_arm64-userdebug</span><br><span class="line"> 10. m_e_arm-userdebug</span><br><span class="line"> 11. m_e_mips64-eng</span><br><span class="line"> 12. m_e_mips-userdebug</span><br><span class="line"> 13. mini_emulator_x86_64-userdebug</span><br><span class="line"> 14. mini_emulator_x86-userdebug</span><br><span class="line"> 15. aosp_dragon-userdebug</span><br><span class="line"> 16. aosp_dragon-eng</span><br><span class="line"> 17. aosp_marlin-userdebug</span><br><span class="line"> 18. aosp_sailfish-userdebug</span><br><span class="line"> 19. aosp_flounder-userdebug</span><br><span class="line"> 20. aosp_angler-userdebug</span><br><span class="line"> 21. aosp_bullhead-userdebug</span><br><span class="line"> 22. hikey-userdebug</span><br><span class="line"> 23. aosp_shamu-userdebug</span><br><span class="line"></span><br><span class="line">Which would you like? [aosp_arm-eng] </span><br></pre></td></tr></table></figure>
<p>这里需要选择编译目标的格式(选择前面的序号，按回车即可)，编译目标的格式组成为<code>BUILD-BUILDTYPE</code>，比如aosp_arm-eng的BUILD为aosp_arm，BUILDTYPE为eng。 其中BUILD表示编译出的镜像可以运行在什么环境，aosp代表Android开源项目，arm表示系统是运行在arm架构的处理器上。 更多参考官方文档<a target="_blank" rel="noopener" href="https://source.android.google.cn/source/running.html#selecting-device-build">文档</a>。<br>BUILDTYPE 指的是编译类型，有以下三种：</p>
<ul>
<li>user：用来正式发布到市场的版本，权限受限，如没有 root 权限，不能 dedug，adb默认处于停用状态。</li>
<li>userdebug：在user版本的基础上开放了 root 权限和 debug 权限，adb默认处于启用状态。一般用于调试真机。</li>
<li>eng：开发工程师的版本，拥有最大的权限(root等)，具有额外调试工具的开发配置。一般用于模拟器。<br>如果你没有Nexus设备，只想编译完后运行在模拟器查看，那么BUILD可以选择aosp_x86，BUILDTYPE选择eng。</li>
</ul>
<h5 id="4-开始编译"><a href="#4-开始编译" class="headerlink" title="(4.)开始编译"></a>(4.)开始编译</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -j8</span><br></pre></td></tr></table></figure>
<p>j后面数字几就是多少线程，最多不超过你的cpu总线程，<br>编译成功会显示如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Creating filesystem with parameters:</span><br><span class="line">    Size: 2147483648</span><br><span class="line">    Block size: 4096</span><br><span class="line">    Blocks per group: 32768</span><br><span class="line">    Inodes per group: 8192</span><br><span class="line">    Inode size: 256</span><br><span class="line">    Journal blocks: 8192</span><br><span class="line">    Label: system</span><br><span class="line">    Blocks: 524288</span><br><span class="line">    Block groups: 16</span><br><span class="line">    Reserved block group size: 127</span><br><span class="line">Created filesystem with 2216/131072 inodes and 199826/524288 blocks</span><br><span class="line">[100% 7669/7669] Install system fs ima.../target/product/generic_x86/system.img</span><br><span class="line">out/target/product/generic_x86/system.img+ maxsize=2192446080 blocksize=2112 total=2147483648 reserve=22146432</span><br><span class="line"></span><br><span class="line">#### make completed successfully (01:24:41 (hh:mm:ss)) ####</span><br></pre></td></tr></table></figure>
<p>会在源码跟目录out&#x2F;target&#x2F;product&#x2F;angler目录下生成镜像文件：</p>
<ul>
<li>system.img：系统镜像</li>
<li>ramdisk.img：根文件系统镜像</li>
<li>userdata.img：用户数据镜像</li>
<li>recovery.img:recovery镜像</li>
<li>boot.img:启动镜像</li>
<li>vendor.img:驱动镜像</li>
</ul>
<p>最终会在 out&#x2F;target&#x2F;product&#x2F;generic_x86&#x2F;目录生成了三个重要的镜像文件： system.img、userdata.img、ramdisk.img。大概介绍着三个镜像文件：</p>
<ul>
<li>system.img：系统镜像，里面包含了Android系统主要的目录和文件，通过init.c进行解析并mount挂载到&#x2F;system目录下。</li>
<li>userdata.img：用户镜像，是Android系统中存放用户数据的，通过init.c进行解析并mount挂载到&#x2F;data目录下。</li>
<li>ramdisk.img：根文件系统镜像，包含一些启动Android系统的重要文件，比如init.rc。</li>
</ul>
<h3 id="3-编译错误解决"><a href="#3-编译错误解决" class="headerlink" title="3.编译错误解决"></a>3.编译错误解决</h3><h5 id="1-缺少libncurses-so-5"><a href="#1-缺少libncurses-so-5" class="headerlink" title="(1.)缺少libncurses.so.5"></a>(1.)缺少libncurses.so.5</h5><p>报错信息:<br><code>error while loading shared libraries: libncurses.so.5: cannot open shared object file: No such file or directory</code><br>解决方式:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br></pre></td></tr></table></figure>

<p>for 32-bit binaries : </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install libncurses5:i386</span><br></pre></td></tr></table></figure>

<p>for 64-bit binaries : </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install libncurses5</span><br></pre></td></tr></table></figure>

<h5 id="2-缺少M4"><a href="#2-缺少M4" class="headerlink" title="(2.)缺少M4"></a>(2.)缺少M4</h5><p>报错信息:<br><code>/bin/bash: m4: command not found</code><br>解决方式:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install m4</span><br></pre></td></tr></table></figure>

<h5 id="3-去除所有本地化设置"><a href="#3-去除所有本地化设置" class="headerlink" title="(3.)去除所有本地化设置"></a>(3.)去除所有本地化设置</h5><p>报错信息:<br><code>FAILED: out/host/linux-x86/obj/EXECUTABLES/checkpolicy_intermediates/policy_scan.c</code><br>解决方法:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export LC_ALL=C</span><br></pre></td></tr></table></figure>
<p>LC_ALL&#x3D;C 是为了去除所有本地化的设置，让命令能正确执行， 但是不可以修改~&#x2F;.bashrc，会导致终端内中文显示为数字(应该是对应的编码)</p>
<h5 id="4-jack-server的问题"><a href="#4-jack-server的问题" class="headerlink" title="(4.)jack-server的问题"></a>(4.)jack-server的问题</h5><p><strong>jack server交互命令:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">jack-admin start-server</span><br><span class="line">jack-admin kill-server</span><br><span class="line">jack-admin list-server</span><br><span class="line">jack-admin uninstall-server</span><br><span class="line">mm -j32 showcommands &amp;&gt; mm.out</span><br><span class="line">jack-admin install-server jack-launcher.jar  jack-server-4.8.ALPHA.jar</span><br><span class="line">jack-admin dump-report</span><br><span class="line">jack-admin dump-re</span><br><span class="line">jack-admin server-log  查找log所在目录</span><br></pre></td></tr></table></figure>

<p><strong>问题一：多用户同时编译时报错</strong><br>错误信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">FAILED: setup-jack-server</span><br><span class="line">/bin/bash -c &quot;(prebuilts/sdk/tools/jack-admin install-server prebuilts/sdk/tools/jack-launcher.jar prebuilts/sdk/tools/jack-server-4.11.ALPHA.jar  2&gt;&amp;1 || (exit 0) ) &amp;&amp; (JACK_SERVER_VM_ARGUMENTS=\&quot;-Dfile.encoding=UTF-8 -XX:+TieredCompilation\&quot; prebuilts/sdk/tools/jack-admin start-server 2&gt;&amp;1 || exit 0 ) &amp;&amp; (prebuilts/sdk/tools/jack-admin update server prebuilts/sdk/tools/jack-server-4.11.ALPHA.jar 4.11.ALPHA 2&gt;&amp;1 || exit 0 ) &amp;&amp; (prebuilts/sdk/tools/jack-admin update jack prebuilts/sdk/tools/jacks/jack-4.31.CANDIDATE.jar 4.31.CANDIDATE || exit 47 )&quot;</span><br><span class="line">Jack server already installed in &quot;/home/disk/lixialong/.jack-server&quot;</span><br><span class="line">Communication error with Jack server (35), try &#x27;jack-diagnose&#x27; or see Jack server log</span><br><span class="line">SSL error when connecting to the Jack server. Try &#x27;jack-diagnose&#x27;</span><br><span class="line">SSL error when connecting to the Jack server. Try &#x27;jack-diagnose&#x27;</span><br></pre></td></tr></table></figure>
<p>解决方案：同时修改$HOME&#x2F;.jack-settings和$HOME&#x2F;.jack-server&#x2F;config.properties中的端口号（比如都改为8386&#x2F;8387，端口号值为0~65535，1024下的值不要用），方可支持多用户同时编译。<br>查看端口是否一致：cat ~&#x2F;.jack-server&#x2F;config.properties|grep -i port &amp;&amp; cat ~&#x2F;.jack|grep -i port|grep -v LOG &amp;&amp;cat ~&#x2F;.jack-settings|grep -i port</p>
<ol>
<li>$HOME&#x2F;.jack-settings<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SERVER_PORT_SERVICE=8386</span><br><span class="line">SERVER_PORT_ADMIN=8387</span><br></pre></td></tr></table></figure></li>
<li>$HOME&#x2F;.jack-server&#x2F;config.properties<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jack.server.service.port=8386</span><br><span class="line">jack.server.admin.port=8387</span><br></pre></td></tr></table></figure></li>
<li>$HOME&#x2F;.jack<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SERVER_PORT_SERVICE=8288</span><br><span class="line">SERVER_PORT_ADMIN=8289</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>问题二： No Jack server running. Try ‘jack-admin start-server’</strong><br>错误信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">com.android.jack.server.api.v01.ServerException: &#x27;./config.properties&#x27; musthave permission rw------- but have rwx------</span><br><span class="line">Caused by: java.io.IOException: &#x27;./config.properties&#x27; must have permissionrw------- but have rwx------</span><br><span class="line">... </span><br></pre></td></tr></table></figure>
<p>解决方案：通过查看文件 $HOME&#x2F;.jack-server&#x2F;logs&#x2F;jack-server-0-0.log：<br>发现是配置文件的权限不对造成的，把文件$HOME&#x2F;.jack-server&#x2F;config.properties的权限由rwx改为rw即可解决问题。<br><strong>问题三：未配置变量信息导致问题</strong><br>错误信息:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR: Communication error with Jack server (52) make: *** [out/target/common/obj/JAVA_LIBRARIES/libutil_intermediates/classes.jack] Error</span><br></pre></td></tr></table></figure>
<p>这种情况多半属于jack-admin缺少变量JACK_JAR而导致的。</p>
<p>解决方案：<br>工程根目录内执行以下三句，再进行编译。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">export JACK_JAR=./out/host/linux-x86/framework/jack.jar</span><br><span class="line"></span><br><span class="line">./out/host/linux-x86/bin/jack-admin stop-server</span><br><span class="line"></span><br><span class="line">./out/host/linux-x86/bin/jack-admin start-server</span><br></pre></td></tr></table></figure>
<p><strong>问题四:TLSv1， TLSv1.1 禁用</strong><br>报错信息:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Ensuring Jack server is installed and started</span><br></pre></td></tr></table></figure>
<p>解决方式:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/java-8-openjdk/security/java.security</span><br></pre></td></tr></table></figure>
<p>vim里面输入&#x2F;搜索jdk.tls.disabledAlgorithms&#x3D; 将TLSv1， TLSv1.1 光标选中输入x删除掉取消禁用.然后wq保存.<br>修改后:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">jdk.tls.disabledAlgorithms=SSLv3, RC4, DES, MD5withRSA, \</span><br><span class="line">    DH keySize &lt; 1024, EC keySize &lt; 224, 3DES_EDE_CBC, anon, NULL, \</span><br><span class="line">    include jdk.disabled.namedCurves</span><br></pre></td></tr></table></figure>
<p>aosp&#x2F;prebuilts&#x2F;sdk&#x2F;tools&#x2F; 目录下执行.&#x2F;jack-admin kill-server &amp;&amp; .&#x2F;jack-admin start-server 成功。</p>
<h5 id="4-xmllint的问题"><a href="#4-xmllint的问题" class="headerlink" title="(4.)xmllint的问题"></a>(4.)xmllint的问题</h5><p>报错信息:<br><code>/bin/bash: xmllint: command not found</code><br>解决方案:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get  install libxml2-utils</span><br></pre></td></tr></table></figure>

<h5 id="5-编译内存不足"><a href="#5-编译内存不足" class="headerlink" title="(5.)编译内存不足"></a>(5.)编译内存不足</h5><p>报错信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Try increasing heap size with java option &#x27;-Xmx&lt;size&gt;&#x27;错误</span><br></pre></td></tr></table></figure>
<p>解决方案:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export JACK_SERVER_VM_ARGUMENTS=&quot;-Dfile.encoding=UTF-8 -XX:+TieredCompilation -Xmx4g&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jack-admin kill-server</span><br><span class="line">jack-admin start-server</span><br></pre></td></tr></table></figure>

<h1 id="五-运行模拟器"><a href="#五-运行模拟器" class="headerlink" title="五.运行模拟器"></a>五.运行模拟器</h1><h3 id="1-启动模拟器"><a href="#1-启动模拟器" class="headerlink" title="1.启动模拟器"></a>1.启动模拟器</h3><p>在编译完成之后，就可以通过以下命令运行Android虚拟机了，由于之前已经执行过source和lunch命令了，可以直接运行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">source build/envsetup.sh</span><br><span class="line">lunch aosp_x86-eng</span><br><span class="line">emulator</span><br></pre></td></tr></table></figure>
<p>就会启动模拟器了.</p>
<h3 id="2-启动模拟器失败"><a href="#2-启动模拟器失败" class="headerlink" title="2.启动模拟器失败"></a>2.启动模拟器失败</h3><p>尝试使用-verbose选项（即“emulator -verbose”），这将打印模拟器正在做什么&#x2F;正在探测哪些文件，并给出有关错误的更多详细信息。<br><code>emulator -use-system-libs</code><br>启动模模拟器报错:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">emulator: ERROR: x86_64 emulation currently requires hardware acceleration!</span><br><span class="line">Please ensure KVM is properly installed and usable.</span><br><span class="line">CPU acceleration status: This user doesn&#x27;t have permissions to use KVM (/dev/kvm)</span><br></pre></td></tr></table></figure>
<ol>
<li>安装 Qemu-KVM 和 cpu-checker<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install qemu-kvm cpu-checker</span><br><span class="line">sudo apt-get install qemu-kvm libvirt-bin ubuntu-vm-builder bridge-utils</span><br></pre></td></tr></table></figure></li>
<li>查看系统 KVM 是否可用<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kvm-ok</span><br><span class="line">  INFO: /dev/kvm exists</span><br><span class="line">  KVM acceleration can be used</span><br><span class="line">```  </span><br><span class="line">3. 创建 kvm 用户组并把当前登录用户（如 peng ）添加到 kvm 用户组</span><br></pre></td></tr></table></figure>
sudo addgroup kvm<br>sudo usermod -a -G kvm peng<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">4. 改变 /dev/kvm 用户组为 kvm</span><br></pre></td></tr></table></figure>
sudo chgrp kvm &#x2F;dev&#x2F;kvm<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">5. 创建 udev rule，并写入 KERNEL==&quot;kvm&quot;, GROUP=&quot;kvm&quot;, MODE=&quot;0660&quot;</span><br></pre></td></tr></table></figure>
sudo gedit &#x2F;etc&#x2F;udev&#x2F;rules.d&#x2F;60-qemu-kvm.rules<br>KERNEL&#x3D;&#x3D;”kvm”, GROUP&#x3D;”kvm”, MODE&#x3D;”0660”<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">6. 重启ubuntu系统然后运行emulator</span><br><span class="line"></span><br><span class="line"># 六.AOSP源码编译某个单独的模块</span><br><span class="line">上面的编译我们都是对整个Android系统进行编译的.如果我们要编译系统的Settings应用模块，这就属于源码单编某一个模块.</span><br><span class="line">在AOSP根目录执行：</span><br></pre></td></tr></table></figure>
source build&#x2F;envsetup.sh<br>lunch aosp_x86-eng<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">进入Settings的目录：</span><br></pre></td></tr></table></figure>
cd packages&#x2F;apps&#x2F;Settings<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">通过mm编译当前目录下的模块，不编译依赖模块。</span><br></pre></td></tr></table></figure>
mm<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">编译成功后会有提示生成文件的存放路径。除了Settings.odex文件，还会在out/target/product/generic_x86/system/priv-app/Settings目录下生成Settings.apk。</span><br><span class="line">此外还有以下命令可以进行单编：</span><br><span class="line">- mmm：编译指定目录下的模块，不编译它所依赖的其它模块。</span><br><span class="line">- mma：编译当前目录下的模块及其依赖项。</span><br><span class="line">- mmma：编译指定路径下所有模块，并且包含依赖。</span><br><span class="line"></span><br><span class="line">如果对系统模块的源码进行修改，查看生成的APK文件，有两种方式：</span><br><span class="line">- 通过adb push或者adb install 来安装APK。</span><br><span class="line">- 使用make snod命令，重新生成 system.img，运行模拟器查看。</span><br><span class="line"></span><br><span class="line"># 七.导入源码到AS</span><br><span class="line">### 1.编译idegen模块，生成IDE项目文件</span><br><span class="line">在源码中，存在idegen模块，该模块专门用来为idea工具生成系统源码的project.默认情况下aosp编译并不会生成该文件。</span><br><span class="line">在开始编译该模块之前，首先确保你已经编译过Android源码了，如果没有，先要进行AOSP编译.和编译普通的模块一样，我们用mmm命令编译idegen.</span><br><span class="line">在开始编译之前，检查out/host/linux-x86/framework/目录下是否存在idegen.jar文件，存在则说明你已经编译过该模块，否者，则需要编译.执行如下命令即可:</span><br></pre></td></tr></table></figure>
source build&#x2F;envsetup.sh 将脚本添加到系统内<br>lunch 并选择要编译的项目<br>mmm development&#x2F;tools&#x2F;idegen&#x2F;<br>sudo .&#x2F;development&#x2F;tools&#x2F;idegen&#x2F;idegen.sh<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">其中mmm development/tools/idegen/执行完成后会生成idegen.jar，而sodo ./development/tools/idegen/idegen.sh则会在源码目录下生成IEDA工程配置文件:android.ipr，android.iml及android.iws.</span><br><span class="line"></span><br><span class="line">简单的说明一下这三个文件的作用:</span><br><span class="line"></span><br><span class="line">- android.ipr:通常是保存工程相关的设置，比如编译器配置，入口，相关的libraries等</span><br><span class="line">- android.iml:则是主要是描述了modules，比如modules的路径，依赖关系等.</span><br><span class="line">- android.iws:则主要是包含了一些个人工作区的设置.</span><br><span class="line"></span><br><span class="line">&gt;&quot;android.iml&quot;和&quot;android.ipr&quot;一般是&quot;只读&quot;的属性，我们这里建议大家，把这两个文件改成可读可写，否则，在更改一些项目配置的时候可能会出现无法保存的情况，执行如下两条命令即可。</span><br></pre></td></tr></table></figure>
sudo chmod 777 android.iml<br>sudo chmod 777 android.ipr<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### 2 导入源码到AndroidStudio</span><br><span class="line">##### (1.)配置AS</span><br><span class="line">IDE内存优化</span><br><span class="line">因为源码数量非常多，所以导入时IDEA/AS会需要大量内存。所以我们需要编辑IDE的VM选项。配置文件为</span><br><span class="line"></span><br><span class="line">IDEA的是IDEA_HOME/bin/idea.vmoptions</span><br><span class="line">AS的是AS_HOME/bin/studio.vmoptions</span><br><span class="line">注意，AS有一个64位版本的配置文件studio64.vmoptions最好一并修改了。</span><br><span class="line"></span><br><span class="line">找到上面的配置文件，将对应的内容修改为</span><br></pre></td></tr></table></figure>
-Xms748m -Xmx748m<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">即将VM的堆内存最小和最大都设置为748m。官方要求至少在748m以上，根据实际情况进行配置即可</span><br><span class="line">##### (2.)导入源码</span><br><span class="line">接下来，我们导入源码:打开Android Studio，点击File-&gt;Open，选择刚才生成的android.ipr文件即可，然后就是漫长的等待，注意此时是将源码完全导入到AS中了。</span><br><span class="line">如果AS运行比较慢我们就需要排除一些不需要导入的模块。</span><br><span class="line"></span><br><span class="line">##### (3.) 排除模块</span><br><span class="line">很多情况下，我们希望不导入某些模块，那么就可以在导入前修改android.iml文件，通过添加配置的方式告诉AS不导入某些模块，比如现在我不想导入art模块，那么就在android.iml文件中添加:</span><br></pre></td></tr></table></figure>
&lt;excludeFloder url&#x3D;”file:&#x2F;&#x2F;$MODULE_DIR$”&#x2F;abi&gt;<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">不难发现，其格式为:``&lt;excludeFloder url=&quot;file://$MODULE_DIR$&quot;/模块名&gt;``</span><br><span class="line"></span><br><span class="line">&gt;注:编译生成的android.iml文件中已经默认排除了一些模块，通过搜索excludeFolder关键字可找到.</span><br><span class="line"></span><br><span class="line">如果比较关心framworks和packages模块，则保留framworks和packages模块，将其他模块全部排除，在android.iml中添加了以下配置:</span><br></pre></td></tr></table></figure>
   <excludeFolder url="file://$MODULE_DIR$/.repo" />
   <excludeFolder url="file://$MODULE_DIR$/abi" />
   <excludeFolder url="file://$MODULE_DIR$/art" />
   <excludeFolder url="file://$MODULE_DIR$/bionic" />
   <excludeFolder url="file://$MODULE_DIR$/bootable" />
   <excludeFolder url="file://$MODULE_DIR$/build" />
   <excludeFolder url="file://$MODULE_DIR$/cts" />
   <excludeFolder url="file://$MODULE_DIR$/dalvik" />
   <excludeFolder url="file://$MODULE_DIR$/developers" />
   <excludeFolder url="file://$MODULE_DIR$/development" />
   <excludeFolder url="file://$MODULE_DIR$/device" />
   <excludeFolder url="file://$MODULE_DIR$/docs" />
   <excludeFolder url="file://$MODULE_DIR$/external" />
   <excludeFolder url="file://$MODULE_DIR$/external/bluetooth" />
   <excludeFolder url="file://$MODULE_DIR$/external/chromium" />
   <excludeFolder url="file://$MODULE_DIR$/external/emma" />
   <excludeFolder url="file://$MODULE_DIR$/external/icu4c" />
   <excludeFolder url="file://$MODULE_DIR$/external/jdiff" />
   <excludeFolder url="file://$MODULE_DIR$/external/webkit" />
   <excludeFolder url="file://$MODULE_DIR$/frameworks/base/docs" />
   <excludeFolder url="file://$MODULE_DIR$/frameworks/base/extension" />
   <excludeFolder url="file://$MODULE_DIR$/hardware" />
   <excludeFolder url="file://$MODULE_DIR$/kernel" />
   <excludeFolder url="file://$MODULE_DIR$/kernel-3.18" />
   <excludeFolder url="file://$MODULE_DIR$/libcore" />
   <excludeFolder url="file://$MODULE_DIR$/libnativehelper" />
   <excludeFolder url="file://$MODULE_DIR$/ndk" />
   <excludeFolder url="file://$MODULE_DIR$/oem-release" />
   <excludeFolder url="file://$MODULE_DIR$/out" />
   <excludeFolder url="file://$MODULE_DIR$/out/eclipse" />
   <excludeFolder url="file://$MODULE_DIR$/out/host" />
   <excludeFolder url="file://$MODULE_DIR$/out/target/common/docs" />
   <excludeFolder url="file://$MODULE_DIR$/out/target/common/obj/JAVA_LIBRARIES/android_stubs_current_intermediates" />
   <excludeFolder url="file://$MODULE_DIR$/out/target/product" />
   <excludeFolder url="file://$MODULE_DIR$/pdk" />
   <excludeFolder url="file://$MODULE_DIR$/platform_testing" />
   <excludeFolder url="file://$MODULE_DIR$/prebuilt" />
   <excludeFolder url="file://$MODULE_DIR$/prebuilts" />
   <excludeFolder url="file://$MODULE_DIR$/rc_projects" />
   <excludeFolder url="file://$MODULE_DIR$/sdk" />
   <excludeFolder url="file://$MODULE_DIR$/system" />
   <excludeFolder url="file://$MODULE_DIR$/tools" />
   <excludeFolder url="file://$MODULE_DIR$/trusty" />
   <excludeFolder url="file://$MODULE_DIR$/vendor" />
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">完成之后，按照上面说的步骤，使用Android Studio选中&quot;android.ipr&quot;打开项目即可。</span><br><span class="line">&gt;等项目加载完成后，我们还可以通过Android Studio对Exclude的Module进行调整，所以也不用害怕这里Exclude掉了有用的代码，或少Exclude了一部分代码，在项目加载完以后再进行调整就行了。此处和在android.iml文件中添加excludeFolder 的功能是一样的；</span><br><span class="line"></span><br><span class="line">打开&quot;Project Structure&quot;，中间的窗口选择&quot;android&quot;，在弹出的窗口中左边栏中选择&quot;Modules&quot;，而后在右边的窗口中选择&quot;Sources&quot;。</span><br><span class="line">在这里我们可以看到项目的所有代码目录，我们可以选中不需要的module，并点击上面的&quot;Excluded&quot;按钮，当被选中的目录变为橙色，即表示完成Exclude操作；</span><br><span class="line">如果想要取消对某代码目录的Exclude操作，选中该目录，再次点击&quot;Excluded&quot;按钮，等待目录变为蓝色即可。 </span><br><span class="line">![](/images/0d5568dc0704484071c79ffafc9f4a59.webp)</span><br><span class="line"></span><br><span class="line">##### (3.) 配置源码正确跳转</span><br><span class="line">当我们导入完源码后，就可以查看整个系统的源码，但是有个问题，打开的Java代码，查看集成关系或者调用关系的时候，还是会跳转到.class文件中，而不是相应的Java类，</span><br><span class="line">比如PhoneWindow.java继承了Window.java，但是我们跳转的时候却跳到了Window.class，并没有跳转到frameworks目录下对应的源码类，而是jar包中的类。</span><br><span class="line">我们需要让其跳转到相应的类中。我们就需要新建一个没有任何jar库的SDK给到系统源码项目的依赖， 这里的配置JDK/SDK，是用于解决在分析和调试源码的过程，能正确地跳转到目标源码，</span><br><span class="line">而非SDK中的代码。 </span><br><span class="line">-  新建JDK</span><br><span class="line">Project Structure -&gt; SDKs， 新建 JDK， 其中JDK目录可选择跟原本JDK一致即可，任意取一个名字，这里取empty_jdk 然后删除这里取empty_jdk其classpath和SourcePath的内容，确保使用Android系统源码文件</span><br><span class="line">![](/images/741503e98ebaf38731e46ca6a74996a9.webp)</span><br><span class="line">jdk_none</span><br><span class="line"></span><br><span class="line">-  配置SDK</span><br><span class="line">Project Structure -&gt; SDKs， 选中与自己编译的AOSP对应的SDk版本(如果没有对应的就到SDKmanager里面取下载一个对应的版本) Android API 28 Platform， 然后选择其Java SDK为前面新建的empty_jdk</span><br><span class="line">![](/images/58a145d0b3b2acc11ec4d057a398cd67.webp)</span><br><span class="line">sdk_none</span><br><span class="line"></span><br><span class="line">- 选择SDK</span><br><span class="line">Project Structure -&gt; Project -&gt; 选中Project SDK， 选择前面的Android API 28 Platform</span><br><span class="line">![](/images/08d2bfa2c04cf43a3ac7b5322ac72e13.webp)</span><br><span class="line">project_sdk</span><br><span class="line"></span><br><span class="line">-  建立依赖</span><br><span class="line">Project Structure -&gt; Modules -&gt; android -&gt; Dependencies: Module选择我们上面编辑过的SDK。然后点击下图绿色的+号来选择Jars or directories，将 aosp/frameworks 目录添加进来，再按照同样的步骤将aosp/external 目录， 也可添加其他所关注的源码；</span><br><span class="line">然后选中其他所有的依赖，点击右边的下移箭头将其他依赖移动到我们添加的目录下面。(或者将其他的所有依赖删除)</span><br><span class="line">![](/images/06c6777d56a3fe108306901c3f11ddd3.webp)</span><br><span class="line">   </span><br><span class="line">&gt;注意，一般我们大部分人不在ubuntu下开发app ，为了能在Windows或Mac系统下也能使用Android Studio查看源码，</span><br><span class="line">可以按照上面的步骤，那样直接拷贝ubuntu下的android.iml和android.ipr文件到Windows或Mac系统下的android源码根目录下，</span><br><span class="line">然后导入Adnroid Studio中，这样就可以在这两个平台上进行查看源码了。        </span><br><span class="line"></span><br><span class="line"># 八.通过AS调试源码</span><br><span class="line">### 1. 打开模拟器</span><br><span class="line">要调试代码，首先要打开模拟器，注意不是Android Studio自带的模拟器，而是通过编译后的代码启动的模拟器，否则可能出现代码不对应的问题。</span><br><span class="line">直接运行emulator命令是无法启动的，执行方法如下：</span><br></pre></td></tr></table></figure>
source build/envsteup.sh</li>
</ol>
<p>lunch 6 &#x2F;&#x2F;和编译时对应</p>
<p>emulator</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">接下来通过Run-&gt;Attache debugger to Android process，在弹出的Choose Process框内必须选择Show all processes，否则看不到相关的进程:然后选择system_process，就可以进行调试了。</span><br><span class="line"></span><br><span class="line"># 九.Android刷机知识</span><br><span class="line">### 1.BootLoader</span><br><span class="line">机器首先要启动，CPU 最先执行的一段程序就是 BootLoader，是在操作系统内核运行之前运行的一段小程序。其实Bootloader就相当于电脑的bios。 通过这段小程序，进行硬件初始化，获取内存大小信息等，调整手机到适配状态，从而将系统的软硬件环境带到一个合适状态，以便为最终调用操作系统内核准备好正确的环境。</span><br><span class="line">。很多的手机厂商都会锁住BootLoader，这样你就只能使用官方的系统，想要第三方的ROM能够运行，或者破解官方系统这时候就需要进行bootloader解锁!这是刷机的第一步， 当然也有很多手机没有bootloader锁!我们只需要知道要想刷机就得先bootloader解锁。</span><br><span class="line">### 2.FastBoot</span><br><span class="line">fastboot，它是bootloader后期进入的一个特殊阶段。例如小米手机开机同时按音量下建就会进入这个模式.也是一种模式。可以通过数据线与电脑连接，然后在电脑上执行一些命令，如刷系统镜像到手机上。fastboot可以理解为实现了一个简单的通信协议，接收命令并更新镜像文件，其他什么的干不了。</span><br><span class="line">需使用USB数据线连接电脑和手机的一种线刷刷机模式，大部分第三方的Recovery刷入，或者救砖均是在Fastboot模式下进行，所以这种方式称为线刷。 fastboot需要bootloader的支持，所以不是每家手机都会支持这种模式。Fastboot 可以说是一个通信协议，电脑可以通过这个通信协议，直接向手机系统不同分区中写入文件（.img 文件）。</span><br><span class="line">###### fastboot(bootloader)模式怎么进入？</span><br><span class="line">大多数安卓手机，都可以在关机状态下，然后同时按住【电源键】+【音量+】键，大约2-3s后，就可以进入Fastboot模式。 作为开发者在开机状态下可以用下面的方式进入：</span><br></pre></td></tr></table></figure>
<p>adb reboot bootloader</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">###### fastboot命令</span><br><span class="line">然后就可以执行下面的fastboot命令了:</span><br></pre></td></tr></table></figure>
<p>fastboot flashing unlock    #6.0以上设备 设备必须解锁，开始刷机（这个不同的手机厂商不同）<br>fastboot erase {partition}  # 擦除分区<br>fastboot  erase  frp    # 擦除 frp 分区，frp 即 Factory Reset Protection，用于防止用户信息在手机丢失后外泄<br>fastboot  flash  boot  boot.img    # 刷入 boot 分区<br>fastboot  flash  system  system.img    # 刷入 system 分区<br>fastboot  flash  recovery  recovery.img    # 刷入 recovery 分区<br>fastboot flashall    #烧写所有分区，注意：此命令会在当前目录中查找所有img文件，将这些img文件烧写到所有对应的分区中，并重新启动手机。<br>fastboot  format  data    # 格式化 data 分区<br>fastboot  flashing lock    # 设备上锁，刷机完毕<br>fastboot  continue    # 自动重启设备<br>fastboot reboot# 重启手机<br>fastboot reboot-bootloader# 重启到bootloader 刷机用<br>fastboot devices  ## 发现手机，显示当前哪些手机通过fastboot连接了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">### 3.Recovery</span><br><span class="line">如果没有进入fastboot，bootloader继续执行，如果又发现有特殊的按键组合，比如小米上是音量上键和开机键，则会进入recovery模式。它里面包含了一个kernel以及一个可执行程序recovery，以</span><br><span class="line">及一些初始化文件。Recovery模式指的是一种可以对安卓机内部的数据或系统进行修改的模式，也叫工程模式，像是电脑上的小型winPE系统，winPE可以在电脑上安装操作系统，或者做些删除备份、管理的工作。</span><br><span class="line">官方Recovery用处不大，所以通常会刷入一个第三方的Recovery ，Recovery 更类似于一个小型的管理系统。只不过功能简单，所做的管理有限。在recovery模式下，会加载了部分文件系统，所以才可以读sdcard中的update.zip进行刷机，当然，也可以清除cache和用户数据。</span><br><span class="line">该模式可根据用户的需要进行修改，因此有官方recovery模式以及第三方recovery模式。第三方recovery模式可以识别第三方rom包，因此可以用来刷机。而官方recovery一般不能识别第三方zip文件。好用的第三方RE:TWRP 和 CWM Recovery刷机包是称为Google Update 格式。在用Recovery恢复时，刷机包通常放在SD卡里，所以这里刷机一般称为卡刷。</span><br><span class="line">### 4.线刷和卡刷</span><br><span class="line">- 线刷： 直接想手机硬盘写入*.img 文件，我个人觉得这种方法比较快捷，而且省事。但是必须借助电脑和数据线。</span><br><span class="line">- 卡刷：就是利用recovery的从SD卡中更新系统的这个功能，如果你想刷第三方Rom，必须刷入个第三方recovery，只有fastboot模式才能刷recovery.img。卡刷有个限制，必须要把想要更新的ROM（Android系统）拷贝到SD卡上。如果手机已经是砖了。那只能用线刷了。</span><br><span class="line"></span><br><span class="line"># 十.手机硬件驱动知识</span><br><span class="line">### 1. 硬件驱动的作用</span><br><span class="line">AOSP是一个由谷歌维护的开源操作系统开发项目，既然是开源项目，也就意味着任何人都可以自由地审查和贡献代码以及修复项目仓库，而谷歌引领着大方向和大部分的开发工作。AOSP会定期为Android加入最新的安全补丁，谷歌每年也会在其I/O开发者大会上公布操作系统的新功能。除了开放贡献代码外，AOSP还可以在开源许可下自由使用和修改。</span><br><span class="line">比如，小米，华为等厂商根据自己的目的自由调整该项目，并开发了自己的衍生产品，包括多用途的emui和miui。需要注意的是，AOSP包含了开发者构建Android所需的一切，但它并不包括成品智能手机所需的一切。</span><br><span class="line">谷歌和AOSP无法为所有硬件配置提供内核设备驱动。所谓设备驱动，是指手机硬件所需的固件，比如处理器或摄像头。手机和SoC制造商，如高通和三星，必须将这些驱动程序纳入他们的Android构建中。</span><br><span class="line">这也是为什么从AOSP到实际设备的系统更新需要一定时间的原因。其次AOSP也不包含谷歌的软件应用套件，如Chrome浏览器、YouTube，甚至谷歌Play商店。</span><br><span class="line">它也不包括谷歌的一些底层技术和API，而这些技术和API可以实现移动支付、语音命令和云存储等功能，这些都是作为谷歌移动服务（GMS）单独授权的。 任何厂商想要在系统中安装GMS，都必须为自己的设备获得GMS授权和移动应用分发协议（MADA），然后通过多项兼容性测试。有Android兼容性测试套件（CTS）来验证软件和硬件以及API。</span><br><span class="line">正因为AOSP开源的特性，许多的硬件厂商的驱动代码并不是开源的，所以AOSP会有一个硬件抽象层 (HAL)，来保证驱动程序代码不被泄露。大多数手机厂商都是从高通等芯片厂商那里获得AOSP版本，该AOSP版本为硬件量身定坐了高通驱动程序，所以刷入真机是可以正常的运行。</span><br><span class="line"></span><br><span class="line">### 2. 如何添加硬件驱动</span><br><span class="line">在上面步骤中我们编译好了AOSP可以直接通过模拟器运行.编译aosp时也会生成system.img文件，这个文件是最终刷机用的，但是system.img文件必须依赖驱动文件生成，</span><br><span class="line">如果没有放入对应的驱动就编译，那么生成的镜像也是无法正常刷机的。通过上文我们知道aosp 仅是一套源码，真机运行需要厂商的驱动，厂商的驱动是不包含在AOSP中的，</span><br><span class="line">第三方ROM(如CM等)的厂家驱动是自行提取的。但是google也开源了nexus和pixel对应的AOSP版本的硬件驱动代码.如果我们有nexus或者是pixel设备就可以下载相应的驱动进行编译，</span><br><span class="line">然后将编译好的系统输入到设备中去.</span><br><span class="line">##### (1.)下载对应的驱动</span><br><span class="line">需要根据你选择的[版本](https://source.android.com/source/build-numbers.html)</span><br><span class="line">去[驱动页面](https://developers.google.com/android/nexus/drivers#shamulrx21o)下载合适的驱动。</span><br><span class="line">##### (2.)生成驱动</span><br><span class="line">将驱动文件下载后，解压到AOSP根目录，得到几个.sh文件，执行后，会在AOSP下创建vendor目录，里面包含了驱动。</span><br><span class="line">##### (3.)编译带有驱动的AOSP</span><br><span class="line">再次`` make -j4``，此次编译的结果就包含了驱动，编译出新的系统.</span><br><span class="line"></span><br><span class="line"># 十一.ROM编译及烧录</span><br><span class="line">一般定制ROM其实就是对手机内存里的system/app文件夹的内容进行自定义，系统所有的程序都在这个文件夹里，比如浏览器、拨号器、联系人等。自己安装的软件\data\文件夹中。</span><br><span class="line">### 1.真机驱动下载</span><br><span class="line">在上文中可以了解到厂商的驱动是不包含在AOSP中的.因此编译出来的AOSP系统源码要在真机上运行，还需要加上厂商驱动进行编译才能烧录到真机上使用.</span><br><span class="line">Google提供了Nexus和Pixel这两个太子机的驱动，我们可以在驱动页面下载合适的驱动。</span><br><span class="line">[Driver Binaries for Nexus and Pixel Devices](https://developers.google.com/android/drivers#walleye)</span><br><span class="line"></span><br><span class="line">### 2.配置真机驱动到AOSP</span><br><span class="line">1. 在上面链接里面,两个文件都进行下载，一个是google vendor，一个qcom。</span><br><span class="line">2. 解压得到``extract-google_devices-blueline.sh``，``extract-qcom-blueline.sh``</span><br><span class="line">3. 将这两个脚本放到aosp代码目录下，进行提取</span><br><span class="line">   ``sh extract-google_devices-blueline.sh``</span><br></pre></td></tr></table></figure>
<p>vendor&#x2F;<br>vendor&#x2F;google_devices&#x2F;<br>vendor&#x2F;google_devices&#x2F;marlin&#x2F;<br>vendor&#x2F;google_devices&#x2F;marlin&#x2F;device-vendor-marlin.mk<br>vendor&#x2F;google_devices&#x2F;marlin&#x2F;android-info.txt<br>vendor&#x2F;google_devices&#x2F;marlin&#x2F;BoardConfigVendor.mk<br>vendor&#x2F;google_devices&#x2F;marlin&#x2F;BoardConfigPartial.mk<br>vendor&#x2F;google_devices&#x2F;marlin&#x2F;proprietary&#x2F;<br>vendor&#x2F;google_devices&#x2F;marlin&#x2F;proprietary&#x2F;vendor.img<br>vendor&#x2F;google_devices&#x2F;marlin&#x2F;device-partial.mk</p>
<p>Files extracted successfully.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">第2个 高通驱动</span><br><span class="line">``sh extract-qcom-blueline.sh``</span><br></pre></td></tr></table></figure>
<p>vendor&#x2F;<br>vendor&#x2F;qcom&#x2F;<br>vendor&#x2F;qcom&#x2F;marlin&#x2F;<br>vendor&#x2F;qcom&#x2F;marlin&#x2F;BoardConfigPartial.mk<br>vendor&#x2F;qcom&#x2F;marlin&#x2F;proprietary&#x2F;<br>vendor&#x2F;qcom&#x2F;marlin&#x2F;proprietary&#x2F;lib64&#x2F;<br>vendor&#x2F;qcom&#x2F;marlin&#x2F;proprietary&#x2F;lib64&#x2F;libbcc.so<br>vendor&#x2F;qcom&#x2F;marlin&#x2F;proprietary&#x2F;lib64&#x2F;libLLVM_android.so<br>vendor&#x2F;qcom&#x2F;marlin&#x2F;proprietary&#x2F;lib64&#x2F;libiperf.so<br>vendor&#x2F;qcom&#x2F;marlin&#x2F;proprietary&#x2F;lib64&#x2F;libminui.so<br>vendor&#x2F;qcom&#x2F;marlin&#x2F;proprietary&#x2F;ATT_profiles.xml<br>vendor&#x2F;qcom&#x2F;marlin&#x2F;proprietary&#x2F;pktlogconf<br>vendor&#x2F;qcom&#x2F;marlin&#x2F;proprietary&#x2F;VZW_profiles.xml<br>vendor&#x2F;qcom&#x2F;marlin&#x2F;proprietary&#x2F;ROW_profiles.xml<br>vendor&#x2F;qcom&#x2F;marlin&#x2F;proprietary&#x2F;libclcore_neon.bc<br>vendor&#x2F;qcom&#x2F;marlin&#x2F;proprietary&#x2F;sanitizer-status<br>vendor&#x2F;qcom&#x2F;marlin&#x2F;proprietary&#x2F;libiperf.so<br>vendor&#x2F;qcom&#x2F;marlin&#x2F;proprietary&#x2F;qcrilhook.jar<br>vendor&#x2F;qcom&#x2F;marlin&#x2F;proprietary&#x2F;libminui.so<br>vendor&#x2F;qcom&#x2F;marlin&#x2F;proprietary&#x2F;libion.so<br>vendor&#x2F;qcom&#x2F;marlin&#x2F;proprietary&#x2F;iperf3<br>vendor&#x2F;qcom&#x2F;marlin&#x2F;device-partial.mk<br>vendor&#x2F;google_devices&#x2F;<br>vendor&#x2F;google_devices&#x2F;marlin&#x2F;<br>vendor&#x2F;google_devices&#x2F;marlin&#x2F;device-vendor-marlin.mk<br>vendor&#x2F;google_devices&#x2F;marlin&#x2F;android-info.txt<br>vendor&#x2F;google_devices&#x2F;marlin&#x2F;BoardConfigVendor.mk</p>
<p>Files extracted successfully.</p>
<pre><code>执行后，会在AOSP下创建vendor目录，里面包含了驱动。编译完成后，执行``make fastboot adb ``单独编译fastboot和adb。

### 3.编译Rom
重新对AOSP进行编译.此次编译的结果就包含了驱动，编译完成后，执行make fastboot adb 单独编译fastboot和adb。

### 4. 烧录Rom到手机
1. 手机启用开发者模式，打开 USB 调试 adb shell 能进入。
2. 开机键 + 音量- 进入 bootloader 模式。
3. 电脑上能识别出来手机并装上了驱动。
4. fastboot devices 能看到设备。
5. 再次执行./fastboot -w flashall将开始刷机，刷完会自动重启，over!

参考资料:
[Android 镜像使用帮助](https://mirrors.tuna.tsinghua.edu.cn/help/AOSP/)
[MIUI ROM适配之旅第一天——认识Android手机](https://www.xiaomi.cn/post/10984220)
[Android FrameWork 学习之Android 系统源码调试](https://www.cnblogs.com/liumce/p/8027559.html)
[从CM刷机过程和原理分析Android系统结构](https://blog.csdn.net/luoshengyang/article/details/29688041)
[Android ROM移植](https://blog.csdn.net/weixin_30924087/article/details/98030409)
[android rom移植知识普及](https://blog.csdn.net/innost/article/details/7623951)
[Android系统源码修改](https://blog.csdn.net/huil0925/category_6259725_2.html)
[android系统的分区结构](https://blog.csdn.net/uglychild/article/details/79550793)
[Android ROM的制作与烧录](https://blog.csdn.net/u010142437/article/details/72834972)
[android系统源码中添加app源码（源码部署移植）](https://blog.csdn.net/zhonglunshun/article/details/70256727)

参考资料:
[Ubentu编译Android源码（AOSP）](https://www.cnblogs.com/caoxinyu/p/10568480.html)
[AOSP源码下载/编译/刷机/调试](http://mouxuejie.com/blog/2019-11-17/aosp-setup/)
[Android rom移植一](https://blog.csdn.net/zy199701/article/details/106478670/)
[目前通用的Android拼包移植方法均是正向移植](http://blog.sina.com.cn/s/blog_b278ce3b010186bw.html)
[Android驱动开发全过程](https://blog.csdn.net/u010783226/article/details/94406309)
</code></pre>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://lxlfpeng.github.io">peng</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://lxlfpeng.github.io/2019/09/28/AOSP%E6%BA%90%E7%A0%81%E4%B9%8B%E7%BC%96%E8%AF%91%E3%80%81%E8%B0%83%E8%AF%95%E3%80%81%E5%88%B7%E6%9C%BA/">https://lxlfpeng.github.io/2019/09/28/AOSP%E6%BA%90%E7%A0%81%E4%B9%8B%E7%BC%96%E8%AF%91%E3%80%81%E8%B0%83%E8%AF%95%E3%80%81%E5%88%B7%E6%9C%BA/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://lxlfpeng.github.io" target="_blank">鹏哥的Blog</a>！</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="/images/about_avatar.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2019/12/10/Android%E9%9F%B3%E8%A7%86%E9%A2%91%E5%BC%80%E5%8F%91%E4%B9%8Bijkplayer/" title="Android音视频开发之ijkplayer"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Android音视频开发之ijkplayer</div></div><div class="info-2"><div class="info-item-1">一.Ijkplayerijk的导入方式有两种，第一种是使用gradle导入ijkplayer发布到jcenter，已经打包好的依赖包，第二种是去github中下载ijkplayer源码，自己进行编译。 1.gradle方式导入：123456789101112# required, enough for most devices.   implementation &#x27;tv.danmaku.ijk.media:ijkplayer-java:0.8.8&#x27;    implementation &#x27;tv.danmaku.ijk.media:ijkplayer-armv7a:0.8.8&#x27;   # Other ABIs: optional   implementation &#x27;tv.danmaku.ijk.media:ijkplayer-armv5:0.8.8&#x27;   implementation &#x27;tv.danmaku.ijk.media:ijkplayer-arm64:0.8.8&#x27;   implementation...</div></div></div></a><a class="pagination-related" href="/2019/08/15/%E4%BD%BF%E7%94%A8Python%E5%88%B6%E4%BD%9C%E7%88%AC%E8%99%AB%E7%A8%8B%E5%BA%8F%E6%80%BB%E7%BB%93/" title="使用Python制作爬虫程序总结"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">使用Python制作爬虫程序总结</div></div><div class="info-2"><div class="info-item-1">...</div></div></div></a></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/images/about_avatar.webp" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">peng</div><div class="author-info-description">过往不恋 未来不迎 当下不负</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">127</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">59</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">24</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/lxlfpeng"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/lxlfpeng" target="_blank" title="Github"><i class="fab fa-github" style="color: #4a7dbe;"></i></a><a class="social-icon" href="mailto:565289282@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">欢迎来到我的博客!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80-%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">1.</span> <span class="toc-text">一.准备工作</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C-%E4%B8%8B%E8%BD%BDAosp%E6%BA%90%E7%A0%81"><span class="toc-number">2.</span> <span class="toc-text">二.下载Aosp源码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%AE%89%E8%A3%85GIT"><span class="toc-number">2.0.1.</span> <span class="toc-text">1.安装GIT</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%A6%96%E5%85%88%E9%9C%80%E8%A6%81%E5%AE%89%E8%A3%85Git%EF%BC%8C%E5%9B%A0%E4%B8%BA%E6%BA%90%E7%A0%81%E6%98%AF%E7%94%A8Git%E7%AE%A1%E7%90%86%E7%9A%84%E3%80%82"><span class="toc-number">2.0.1.0.1.</span> <span class="toc-text">首先需要安装Git，因为源码是用Git管理的。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8E%A5%E4%B8%8B%E6%9D%A5%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AAbin%E6%96%87%E4%BB%B6%E5%A4%B9%EF%BC%8C%E5%B9%B6%E5%8A%A0%E5%85%A5%E5%88%B0PATH%E4%B8%AD%EF%BC%8C%E6%9C%89%E7%82%B9%E5%83%8FWindows%E7%9A%84%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E3%80%82"><span class="toc-number">2.0.1.0.2.</span> <span class="toc-text">接下来创建一个bin文件夹，并加入到PATH中，有点像Windows的环境变量。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%84%B6%E5%90%8E%E5%88%9D%E5%A7%8B%E5%8C%96Git%EF%BC%8C%E9%82%AE%E7%AE%B1%E5%92%8C%E5%A7%93%E5%90%8D%E3%80%82"><span class="toc-number">2.0.1.0.3.</span> <span class="toc-text">然后初始化Git，邮箱和姓名。</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%AE%89%E8%A3%85Python%E7%8E%AF%E5%A2%83"><span class="toc-number">2.0.2.</span> <span class="toc-text">2.安装Python环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%AE%89%E8%A3%85repo%E5%8F%8A%E9%85%8D%E7%BD%AE"><span class="toc-number">2.0.3.</span> <span class="toc-text">3.安装repo及配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%AE%89%E8%A3%85curl%E4%B8%8B%E8%BD%BD%E7%9A%84%E5%BA%93%EF%BC%9A"><span class="toc-number">2.0.3.0.1.</span> <span class="toc-text">(1.)安装curl下载的库：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E4%B8%8B%E8%BD%BDrepo%E5%B9%B6%E8%AE%BE%E7%BD%AE%E5%8F%AF%E4%BB%A5%E8%BF%90%E8%A1%8C%E6%9D%83%E9%99%90%E3%80%82"><span class="toc-number">2.0.3.0.2.</span> <span class="toc-text">(2.)下载repo并设置可以运行权限。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E6%B7%BB%E5%8A%A0%E4%B8%8B%E8%BD%BD%E6%BA%90%E3%80%82"><span class="toc-number">2.0.3.0.3.</span> <span class="toc-text">(3.)添加下载源。</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%88%9D%E5%A7%8B%E5%8C%96%E5%8F%8A%E5%90%8C%E6%AD%A5%E6%BA%90%E7%A0%81"><span class="toc-number">2.0.4.</span> <span class="toc-text">4.初始化及同步源码</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%88%9B%E5%BB%BA%E6%96%87%E4%BB%B6%E5%A4%B9"><span class="toc-number">2.0.4.0.1.</span> <span class="toc-text">(1.)创建文件夹</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E5%88%9D%E5%A7%8B%E5%8C%96Aosp%E4%BB%93%E5%BA%93"><span class="toc-number">2.0.4.0.2.</span> <span class="toc-text">(2.)初始化Aosp仓库</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E5%88%9D%E5%A7%8B%E5%8C%96%E5%B9%B6%E6%8C%87%E5%AE%9A%E7%89%88%E6%9C%AC"><span class="toc-number">2.0.4.0.3.</span> <span class="toc-text">(3.)初始化并指定版本</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-%E5%BC%80%E5%A7%8B%E5%90%8C%E6%AD%A5%E6%BA%90%E7%A0%81"><span class="toc-number">2.0.4.0.4.</span> <span class="toc-text">(4.)开始同步源码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E9%A2%84%E4%B8%8B%E8%BD%BD%E5%8C%85%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="toc-number">2.0.5.</span> <span class="toc-text">5.预下载包的方式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E4%B8%8B%E8%BD%BD%E9%A2%84%E4%B8%8B%E8%BD%BD%E5%8C%85"><span class="toc-number">2.0.5.0.1.</span> <span class="toc-text">1. 下载预下载包</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E8%A7%A3%E5%8E%8B%E9%A2%84%E4%B8%8B%E8%BD%BD%E5%8C%85"><span class="toc-number">2.0.5.0.2.</span> <span class="toc-text">2. 解压预下载包</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E6%9F%A5%E7%9C%8B%E5%88%86%E6%94%AF"><span class="toc-number">2.0.5.0.3.</span> <span class="toc-text">3. 查看分支</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-%E5%9C%A8aosp%E7%9B%AE%E5%BD%95%E9%80%89%E6%8B%A9%E9%9C%80%E8%A6%81%E5%90%8C%E6%AD%A5%E7%9A%84%E7%89%88%E6%9C%AC"><span class="toc-number">2.0.5.0.4.</span> <span class="toc-text">4. 在aosp目录选择需要同步的版本</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E9%98%B2%E6%AD%A2%E4%B8%8B%E8%BD%BD%E6%BA%90%E7%A0%81%E6%89%A7%E8%A1%8C%E8%84%9A%E6%9C%AC%E5%8D%A1%E6%AD%BB"><span class="toc-number">2.0.6.</span> <span class="toc-text">6.防止下载源码执行脚本卡死</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%9C%A8AOSP%E6%96%87%E4%BB%B6%E5%A4%B9%E4%B8%AD%E6%96%B0%E5%BB%BAdown-sh%E6%96%87%E4%BB%B6"><span class="toc-number">2.0.6.0.1.</span> <span class="toc-text">(1.)在AOSP文件夹中新建down.sh文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E6%89%A7%E8%A1%8Cdown-sh%E6%96%87%E4%BB%B6"><span class="toc-number">2.0.6.0.2.</span> <span class="toc-text">(2.)执行down.sh文件</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89-AOSP%E6%BA%90%E7%A0%81%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="toc-number">3.</span> <span class="toc-text">三.AOSP源码目录结构</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B-AOSP%E6%BA%90%E7%A0%81%E6%95%B4%E7%BC%96"><span class="toc-number">4.</span> <span class="toc-text">四.AOSP源码整编</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%AE%89%E8%A3%85Java%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83"><span class="toc-number">4.0.1.</span> <span class="toc-text">1.安装Java编译环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E8%BF%9B%E5%85%A5AOSP%E6%96%87%E4%BB%B6%E5%A4%B9%EF%BC%8C%E8%BF%9B%E8%A1%8C%E7%BC%96%E8%AF%91"><span class="toc-number">4.0.2.</span> <span class="toc-text">2.进入AOSP文件夹，进行编译</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%88%9D%E5%A7%8B%E5%8C%96%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83"><span class="toc-number">4.0.2.0.1.</span> <span class="toc-text">(1.)初始化编译环境</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E5%88%A0%E9%99%A4%E4%B8%8A%E4%B8%80%E6%AC%A1%E7%BC%96%E8%AF%91%E7%9A%84%E7%BB%93%E6%9E%9C%EF%BC%8C%E5%88%9D%E6%AC%A1%E7%BC%96%E8%AF%91%E5%8F%AF%E4%BB%A5%E4%B8%8D%E9%9C%80%E8%A6%81%E8%BF%99%E4%B8%80%E6%AD%A5"><span class="toc-number">4.0.2.0.2.</span> <span class="toc-text">(2.)删除上一次编译的结果，初次编译可以不需要这一步</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E9%80%89%E6%8B%A9%E4%B8%8E%E8%AE%BE%E5%A4%87%E5%AF%B9%E5%BA%94%E7%9A%84%E7%BC%96%E8%AF%91%E7%89%88%E6%9C%AC"><span class="toc-number">4.0.2.0.3.</span> <span class="toc-text">(3.)选择与设备对应的编译版本</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-%E5%BC%80%E5%A7%8B%E7%BC%96%E8%AF%91"><span class="toc-number">4.0.2.0.4.</span> <span class="toc-text">(4.)开始编译</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E7%BC%96%E8%AF%91%E9%94%99%E8%AF%AF%E8%A7%A3%E5%86%B3"><span class="toc-number">4.0.3.</span> <span class="toc-text">3.编译错误解决</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E7%BC%BA%E5%B0%91libncurses-so-5"><span class="toc-number">4.0.3.0.1.</span> <span class="toc-text">(1.)缺少libncurses.so.5</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E7%BC%BA%E5%B0%91M4"><span class="toc-number">4.0.3.0.2.</span> <span class="toc-text">(2.)缺少M4</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E5%8E%BB%E9%99%A4%E6%89%80%E6%9C%89%E6%9C%AC%E5%9C%B0%E5%8C%96%E8%AE%BE%E7%BD%AE"><span class="toc-number">4.0.3.0.3.</span> <span class="toc-text">(3.)去除所有本地化设置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-jack-server%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">4.0.3.0.4.</span> <span class="toc-text">(4.)jack-server的问题</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-xmllint%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">4.0.3.0.5.</span> <span class="toc-text">(4.)xmllint的问题</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-%E7%BC%96%E8%AF%91%E5%86%85%E5%AD%98%E4%B8%8D%E8%B6%B3"><span class="toc-number">4.0.3.0.6.</span> <span class="toc-text">(5.)编译内存不足</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94-%E8%BF%90%E8%A1%8C%E6%A8%A1%E6%8B%9F%E5%99%A8"><span class="toc-number">5.</span> <span class="toc-text">五.运行模拟器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%90%AF%E5%8A%A8%E6%A8%A1%E6%8B%9F%E5%99%A8"><span class="toc-number">5.0.1.</span> <span class="toc-text">1.启动模拟器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%90%AF%E5%8A%A8%E6%A8%A1%E6%8B%9F%E5%99%A8%E5%A4%B1%E8%B4%A5"><span class="toc-number">5.0.2.</span> <span class="toc-text">2.启动模拟器失败</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background: linear-gradient(20deg, #0062be, #925696, #cc426e, #fb0347);"><div id="footer-wrap"><div class="copyright">&copy;2015 - 2025 By peng</div><div class="footer_custom_text"> <a target="_blank" rel="nofollow noopener"><span>千里之行</span></a> <i class="iconfont icon-love"></i> <a target="_blank" rel="nofollow noopener"><span>始于足下</span></a> </div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.isShuoshuo
  const option = null

  const getGiscusTheme = theme => theme === 'dark' ? 'dark' : 'light'

  const createScriptElement = config => {
    const ele = document.createElement('script')
    Object.entries(config).forEach(([key, value]) => {
      ele.setAttribute(key, value)
    })
    return ele
  }

  const loadGiscus = (el = document, key) => {
    const mappingConfig = isShuoshuo
      ? { 'data-mapping': 'specific', 'data-term': key }
      : { 'data-mapping': (option && option['data-mapping']) || 'pathname' }

    const giscusConfig = {
      src: 'https://giscus.app/client.js',
      'data-repo': 'lxlfpeng/blog_comments',
      'data-repo-id': 'R_kgDONYoexA',
      'data-category-id': 'DIC_kwDONYoexM4Ck4JQ',
      'data-theme': getGiscusTheme(document.documentElement.getAttribute('data-theme')),
      'data-reactions-enabled': '1',
      crossorigin: 'anonymous',
      async: true,
      ...option,
      ...mappingConfig
    }

    const scriptElement = createScriptElement(giscusConfig)

    el.querySelector('#giscus-wrap').appendChild(scriptElement)

    if (isShuoshuo) {
      window.shuoshuoComment.destroyGiscus = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }
  }

  const changeGiscusTheme = theme => {
    const iframe = document.querySelector('#giscus-wrap iframe')
    if (iframe) {
      const message = {
        giscus: {
          setConfig: {
            theme: getGiscusTheme(theme)
          }
        }
      }
      iframe.contentWindow.postMessage(message, 'https://giscus.app')
    }
  }

  btf.addGlobalFn('themeChange', changeGiscusTheme, 'giscus')

  if (isShuoshuo) {
    'Giscus' === 'Giscus'
      ? window.shuoshuoComment = { loadComment: loadGiscus }
      : window.loadOtherComment = loadGiscus
    return
  }

  if ('Giscus' === 'Giscus' || !false) {
    if (false) btf.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
    else loadGiscus()
  } else {
    window.loadOtherComment = loadGiscus
  }
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>